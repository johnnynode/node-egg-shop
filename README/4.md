### 购物车功能

- 加入购物车
    * 获取商品信息数据(商品id: goods_id，颜色id: color_id)
    * 判断购物车(cookies)是否存在数据
    * 如果购物车空的，直接写入当前数据
    * 如果购物车存在数据
        * 判断购物车是否存在当前数据
        * 存在，则当前数据自增1
        * 不存在，则将当前数据写入cookies
- 加入成功页面
- 购物车商品列表
- 购物车内增加商品数量
- 购物车内减少商品数量
- 删除购物车数据
- 改变购物车数据状态(选中)
- 改变购物车所有数据状态
- 关于购物车数据的保存
    * 方法1：保存购物车数据在本地
    * 方法2：保存购物车数据在服务器
    * 方法3：先保存购物车数据在本地，用户登录后同步到服务器(项目使用这种，所以暂不需要考虑用户是否登录)
- 封装cookie相关操作
    * 注意设置httpOnly来只让后端修改cookie,保护数据安全
    * 具体参考：app/service/cookies.js
- 购物车工具方法
    * 参考：app/service/cart.js
- 去结算功能
  * 涉及到用户是否登录的判断
  * 属于购物车的一部分功能
- 购物车所有功能
    * 具体参考：app/controller/web/cart.js

### 前台用户注册登录功能

**短信**

- 我们的后端想要使用短信接口服务，一般需要如下步骤：
- 一、找到短信运营商
    * 云片: https://www.yunpian.com/
    * 聚合数据: https://www.juhe.cn/service
    * 阿里大鱼
    * 腾讯云
    * ...
    * 甚至可以搜索"短信接口运营商"
- 二、在运营商网站注册并完成认证
    * 这里我们采用云片提供的服务
- 三、在其后台管理中创建签名
    * 这个签名一般就是我们自己企业的公司名或者相关品牌标识
    * 签名显示在短信内容的最前面，显示这条短信来自哪家公司/产品/网站。因运营商要求，签名需经过审核
- 四、创建模板
    * 一般模板的内容如下：
    * 您的验证码是#code#, 如非本人操作，请忽略本短信
- 五、找到sdk和官方文档实现发送短信
    * 没有提供nodejs的SDK，但是提供nodejs的示例代码, 如下链接，因为是项目外链，不保证一直可以访问：
    * https://www.yunpian.com/official/document/sms/zh_CN/introduction_demos_nodejs
    * 将其代码拿到封装成我们自己的库
    * 示例代码提供：单条短信发送，模板短信发送，语音短信发送等
    * 注意，一般会有使用限制，电信运营商不允许一直发验证码(恶意攻击)，验证类短信1小时内同一手机号发送次数不能超过3次，这个可以和运营商沟通
    * 同时，我们在项目中也应该有相同的限制处理，禁止用户频繁发送短信验证码
    * 还要注意，如果短信出现异常应该记录至日志或数据库中
    * 参考项目代码：app/service/sendmsg.js

**登录**

- 注册登录的验证程序最好在前台用相关validate库进行操作TODO，可以优化
- 在提交数据的时候注意关闭csrf验证，在config中的ignore中配置
- 登录的时候是否需要做一些登录日志的记录TODO, 如: user_log, admin_log 表
- 扫码登录是否需要做TODO，(扫码登录的原理)
- 登录安全性问题考虑：
    * 验证码的安全性问题：注意当登录发生错误时，要重新生成一次验证码(前后端都要同步处理)
    * 前台传递参数时候，关于密码需要进行md5加密传输TODO, 后台继续加密已经加密后的密码，之后与数据库中的密码进行比较验证
    * 使用cookie存储登录信息的时候，一定要注意加密操作，具体见cookie的封装

**注册**

- 注册的一般步骤
    * 填写手机号和图形验证码，一般需要验证手机号是否合法，是否在用户中存在
    * 图形验证码验证成功，则请求服务器接口生成短信验证码并发送短信
    * 用户接收到短信，输入短信验证码，用户点击下一步
    * 通过接口，服务器验证用户输入的验证码和后台发送的验证码是否一致
    * 不一致则提示，一致则进入下一个页面进行设置账户密码操作
    * 之后将用户手机号和密码作为一个新的用户进行生成新的用户
- 需要注意的是前后台的图形验证码要分开，不能使用一个，否则会出问题
- 在数据库中有两张用户表：user_temp, user 
    * user_temp 用于限制短信发送次数
    * user 真正的用户表
    * 注意程序中关于次数的验证逻辑：不仅针对手机号，而且针对ip
- 关于密码的存储问题，需要前台进行加密处理，后台再次加密之后存储
- 注意，注册完毕后就直接登录：因为验证用户信息的在中间件中，只需要查询用户保存cookie即可，之后跳转即实现了自动登录
- 具体参考项目代码：app/web/user.js

### 确定订单功能

- 在下单之前，一般需要选择收货地址，快递，发票，兑换券等操作, 也就是确定订单功能，项目只涉及收货地址的选择，没有其他复杂业务
- 收货地址相关功能
    * 用户与地址是1对多的关系
    * 具体功能有：新增收货地址，获取收货地址列表，获取单个收货地址，编辑单个收货地址，修改默认收货地址，移除收货地址TODO
        * 新增收货地址需要特别注意: 更新用户所有地址的默认地址状态为0，新增当前地址并设置默认地址状态为1，查询用户所有收货地址返回
    * 主要是对address表的增删查改操作，注意默认收货地址的字段
- 具体参考项目代码：app/web/address.js

### 下单功能

- 下单也就是提交订单，也就是将下单信息提交到数据库中保存，并且清理购物车中的相关数据
- 下单信息包括：收货地址信息，所购商品的信息等
- 总共涉及两张表：order表和order_item表，两张表通过order_id进行关联
    * order表存储订单
    * order_item表存储订单的商品信息
- 订单生成成功，跳转到支付页面
- 注意，各种提交条件的合法性和合理性判断
- 特别注意，订单提交的时候要防止重复提交，前后端都需要分别处理一下，后端用一个session签名标识来防止重复提交(需要前端协助传值)
- 关于订单的定时取消，建议在数据库中设置存储过程任务，跑定时任务或者开多线程不是太好TODO
- 具体参考项目代码：app/web/order.js

### 支付相关

**微信**

- 准备
    * 个体工商户、企业、政府及事业单位
    * https://pay.weixin.qq.com/static/applyment_guide/applyment_detail_website.shtml
    * 需要获取内容：
        * appid：应用 APPID（必须配置，开户邮件中可查看）
        * MCHID：微信支付商户号（必须配置，开户邮件中可查看）
        * KEY：API 密钥，参考开户邮件设置（必须配置，登录商户平台自行设置）32位的密钥

- 注册商户平台，申请微信支付 1~5个工作日
    * 注册微信商户平台
    * 信息必须如实填写，以及销售商品的分类选择要和自己公司的匹配，不然容易审核失败。审核失败后，看看失败原因、修改重新提交申请。
    * 开户成功，登录商户平台进行验证 
    * 资料审核通过后，商户信息会发到您的账户邮箱里面，请登录联系人邮箱查收商户号和密码，并登录商户平台填写财付通备付金打的小额资金数额，完成账户验证
    * https://kf.qq.com/faq/161220mQjmYj161220n6jYN7.html
    * 登录商户平台点击产品中心开通 Native 支付
    * 用微信给你发的商户号登陆对应的微信商户平台，获取API 密钥
        * 步骤：微信商户平台(pay.weixin.qq.com)-->账户设置-->API 安全-->密钥设置。
        * 设置地址：https://pay.weixin.qq.com/index.php/account/api_cert
        * 设置的时候可能会提示你安装证书
    * PC端用到的方式是Native支付，申请后，要进入商户平台-产品中心 查看Native是否开通，没有开通需要开通
    * APIkey设置在：商户平台-账户中心-API安全-设置密钥, (首次设置应该会要求安装浏览器证书)

- 微信 pc 端网站支付流程
    * https://pay.weixin.qq.com/wiki/doc/api/native.php?chapter=6_5
    * 这是一个非常复杂的业务流程说明，有很多和我们开发接入并没有关系，主要讲述了整个流程
    * 我们接入主要需要考虑一下几点：
        * 1.调用统一下单接口生成预支付交易信息，返回 code_url(二维码链接地址)
        * 2.用 code_url 生成二维码，用于用户扫码支付
        * 3.支付成功后监听服务器的异步通知，然后处理订单

- 调用写好的模块生成 code_url
    * 安装模块 cnpm install request crypto xml2js --save
    * 引入写好的 wechatPay.js var wechatPay = require('./module/wechatPay');
    * 调用统一下单接口获取 code_url
    * 把 code_url 转化成二维码
    * 处理异步通知

- 注意
    * 域名必须备案，不能是ip
    * 产品中心->Native->产品设置->扫码支付 扫码回调链接必须配置, 这个链接就是我们config中的wechat相关的notify_url,微信给我们post数据的链接

**支付宝**

- 接入支付宝
    * 必须注册**企业支付宝账户**
    * 支付宝开发接入页面：https://open.alipay.com/developmentAccess/developmentAccess.html
    * 点击支付应用
    * 填写对应应用名称, 点击创建
    * 创建以后进入概览页面, 上传应用图标
    * 设置应用公钥，提交审核
- 接口加密签名
    * 下载签名工具：https://opendocs.alipay.com/open/291/106097/
    * 选择非Java(java语言还是选择java适用)，点击生成密钥，会生成两个：商户应用私钥，商户应用公钥
    * 复制应用公钥，在支付宝后台开发设置中 设置应用公钥 粘贴进去，保存后会生成一个支付宝公钥
    * 签名。并保存好私钥、公钥
- 配置签名 提交审核
    * 审核周期为1天
- 官方支付流程
    * 官方支付流程文档：https://docs.open.alipay.com/203/107084/
- 支付宝支付官方文档
    * https://docs.open.alipay.com/270/105899/
- Nodejs 支付宝支付实现步骤
    * 1、登录支付宝开放平台 获取应用 APPID、获取支付宝公钥、以及 RSA 签名的应用私钥
        * 注意：RSA 签名验签工具可以生成应用私钥和应用公钥，我们在支付宝开放平台填写应用公钥生成支付宝公钥
    * 2、调用 nodejs 支付宝支付 sdk 实现支付
        * Nodejs Aliapy Sdk 文档：https://github.com/Luncher/alipay
    * 3、 Aliapy Sdk 的使用：
        * 安装模块 $ `npm i alipay-mobile -S`
        * 引入模块 `const Alipay = require('alipay-mobile')`
        * 配置开放平台 appid、 你的应用私钥、蚂蚁金服支付宝公钥 
            * `const options = {app_id: '', appPrivKeyFile: "应用私钥", alipayPubKeyFile: "支付宝公钥"}`
        * 实例化 `Alipay const service = new Alipay(options);`
        * 配置支付订单的信息、以及配置支付参数
        * 生成支付宝支付跳转地址
        * 处理异步通知