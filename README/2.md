### 后台登录相关功能

1 ) **配置登录相关需要的路由模块**

```js
    // 后台登录
    router.get('/admin/login', controller.admin.login.index);
    router.post('/admin/doLogin', controller.admin.login.doLogin);
    router.get('/admin/verify', controller.admin.base.verify);
    router.get('/admin/loginOut', controller.admin.login.loginOut);
```

2 ）**登录验证**

- 判断用户是否登录，未登录去登录，没有账号去注册(此处只谈登录)
- 这个判断功能必须要在中间件中来处理
- middleware/adminauth.js 参考, 相关具体代码和配置需参考原项目，这里有其他后面添加的权限功能，仅供参考使用
    ```js
    'use strict';

    const url = require('url');

    module.exports = (options, app) => {
        return async function adminauth(ctx, next) {
            /*
                1、用户没有登录跳转到登录页面
                2、只有登录以后才可以访问后台管理系统
            */
            ctx.state.csrf = ctx.csrf; // 全局变量 用于接受post请求时的验证
            ctx.state.prevPage = ctx.request.headers.referer; // 全局变量
            const pathname = url.parse(ctx.request.url).pathname;

            if (ctx.session.userinfo) {
                ctx.state.userinfo = ctx.session.userinfo; // 挂载全局变量
                const hasAuth = await ctx.service.admin.checkAuth();
                // console.log('hasAuth', hasAuth);
                // console.log('ctx.state.userinfo', ctx.state.userinfo);
                if (hasAuth) {
                    // 获取权限列表
                    ctx.state.sideList = await ctx.service.admin.getAuthList(ctx.session.userinfo.role_id);
                    // console.log('ctx.session.userinfo.role_id', ctx.session.userinfo.role_id);
                    console.log('ctx.state.sideList', ctx.state.sideList);
                    await next();
                } else {
                    ctx.body = '您没有权限访问当前地址';
                }
            } else {
                // 排除不需要做权限判断的页面  /admin/verify?mt=0.7466881301614958
                if (pathname === '/admin/login' || pathname === '/admin/doLogin' || pathname === '/admin/verify') {
                    await next();
                } else {
                    ctx.redirect('/admin/login');
                }
            }
        };
    };
    ```
- 之后在config/config.default.js中配置
    ```js
    config.middleware = ['adminauth'];
    config.adminauth = {
        match: '/admin',
    };
    ```
- 当然可以针对路由配置中间件，但是比较麻烦不推荐

2 ）**编写登录模板页面**

- 具体编码此处不再赘述
- 注意在前端要用js验证用户输入的信息是否正确，安全性判断
- 在传输密码前用md5加密用户密码，确保传输的是密文，这块项目是在后台来做了，不太安全

3 ) **编写相关控制器**

- 主要步骤：
    * 获取表单提交的数据，并判断数据格式是否正确(数据格式这块最好添加上验证，项目中没有加)
    * 后台判断验证码是否匹配
    * 查询数据库判断用户/密码是否存在或合法

        2）数据库相关
        1、配置mongoose
        2、创建操作数据库的model
        3、在用户表（集合）中查询当前用户是否存在
        （mongoose操作mongodb数据库）https://www.npmjs.com/package/egg-mongoose
        4、如果数据库有此用户（登录成功） ：保存用户信息 跳转到后台管理系统
        5、如果数据库有此用户（登录失败）： 跳转到登录页面
        6、验证码错误： 跳转到登录页面, 提示验证码不正确
      */
